# Note: This file is only used for Atlantis local development
services:
  ngrok:
    image: wernight/ngrok:latest@sha256:d211f29ebcfe5f4e72df4fa8bdd9a667886e127d7fcb1be4a1af5ad83a8a1b77
    ports:
      - 4040:4040
    environment:
      # https://dashboard.ngrok.com/get-started/your-authtoken
      NGROK_AUTH: "Your auth token"
      NGROK_PROTOCOL: http
      NGROK_PORT: atlantis:4141
    depends_on:
      - atlantis
  atlantis:
    build:
      context: .
      dockerfile: Dockerfile
    command: "atlantis server --config /config.yaml"
    ports:
      - 4141:4141
    volumes:
      # - ${HOME}/.aws:/home/atlantis/.aws/:ro
      - ./config.yaml:/config.yaml
    environment:
      ATLANTIS_GH_USER: "your-github-user"
      ATLANTIS_GH_TOKEN: "your-github-token"
      ATLANTIS_GH_WEBHOOK_SECRET: "your-webhook-secret"
      # ATLANTIS_REPO_CONFIG: "/home/atlantis/atlantis.yaml" # Use ATLANTIS_REPO_CONFIG_JSON instead
      # ATLANTIS_REPO_CONFIG_JSON: '[{"id":"/.*/","branch":"/.*/","plan_requirements":["mergeable"],"apply_requirements":["approved"],"import_requirements":["approved"],"allowed_overrides":["workflow","plan_requirements"],"allow_custom_workflows":true,"policy_check":true}]'
      AWS_PROFILES: |
        [
          {
            "wmkt-gce-sandbox": "arn:aws:iam::884977855360:role/wmkt_gce_sandbox-atlantis-source-role",
            "region": "us-west-2"
          },
          {
            "wmkt-gce-prod": "arn:aws:iam::884977855360:role/atlantis-20250325181155424300000002",
            "region": "us-east-1"
          },
          {
            "terraform-state": "arn:aws:iam::884977855360:role/atlantis_state_lock",
            "region": "us-west-2"
          }
        ]
      REGISTRY_JSON: |
        {
          "credentials":{
            "gcewebmkt.jfrog.io": {
              "token": "eyJ2ZXIiOiIyIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYiLCJraWQiOiJvcl82M2NJVXk3X2JaQV9RU3QteENqOUVFVExydU9MblhLTE10alEyaWVFIn0.eyJzdWIiOiJqZmFjQDAxZThhcDNxNDFmcG43MDlrYXBwMDEwdGU4L3VzZXJzL2F0bGFudGlzIiwic2NwIjoiYXBwbGllZC1wZXJtaXNzaW9ucy9hZG1pbiIsImF1ZCI6IipAKiIsImlzcyI6ImpmZmVAMDFlOGFwM3E0MWZwbjcwOWthcHAwMTB0ZTgiLCJpYXQiOjE3NDMwMjQ1MTYsImp0aSI6IjZlZTBlNjljLWNiOTctNGM2OS1hNjAyLWM3NDY5Nzk5YmQ4NSIsInRpZCI6ImdjZXdlYm1rdCJ9.OB--FGqRxt3G6ZCQeCyuUP9Gsz7MMPZbdPDPTXZr9D_5CsseOe2bU6zDmL_-lWaXANhmnIi2sSzru5BuQ9AQOj5Ys3RY-06ILJayIDe2hh1kBCq6baMTQdkqBDLol9MbAYS_F0FfXw1oA85U72qAgvcZhLiKyLaoamZ8JxVB0zpfvcp13OlOWCrenC6S25_kkX70kxFntnuMSqdNdlhchgW3w7dcMpAsjpxveia1aP6K0d5kJbWtzIeF--H1zY8-pGy9FP1Gi82so28OPU1BQvK-LjH4-UUVUUocIMmYIqrM2UhEs7g1LauK0BjEjTJypK4qAeDDf3O6gsM7kA1EEw"
            }
          }
        }
volumes:
  atlantis:
